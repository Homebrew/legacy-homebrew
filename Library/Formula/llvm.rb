require 'formula'

class Clang < Formula
  homepage  'http://clang.llvm.org/'
  url       'http://llvm.org/releases/3.2/clang-3.2.src.tar.gz'
  sha1      'b0515298c4088aa294edc08806bd671f8819f870'

  head      'http://llvm.org/git/clang.git'
end

class CompilerRt < Formula
  homepage  'http://compiler-rt.llvm.org/'
  url       'http://llvm.org/releases/3.2/compiler-rt-3.2.src.tar.gz'
  sha1      '718c0249a00e928f8bba32c84771da998ea4d42f'

  head      'http://llvm.org/git/compiler-rt.git'
end

class Llvm < Formula
  homepage  'http://llvm.org/'
  url       'http://llvm.org/releases/3.2/llvm-3.2.src.tar.gz'
  sha1      '3ce15bffdca066d8542e011cd1a7e387a134b2d0'
  head      'http://llvm.org/git/llvm.git'

  def patches; DATA; end

  bottle do
    sha1 '9fddf0bfed060ade86c88b64c40cc4bd5f1f0f2c' => :mountainlion
    sha1 '8d3f3d5090d3bd2cf0c953da105efc63080e948f' => :lion
    sha1 '3ba0beee27d60e80e9790cca9d5e21b2b8169ffe' => :snowleopard
  end

  option :universal
  option 'with-clang', 'Build Clang C/ObjC/C++ frontend'
  option 'shared', 'Build LLVM as a shared library'
  option 'all-targets', 'Build all target backends'
  option 'rtti', 'Build with C++ RTTI'

  def install
    if build.universal? and build.include? 'shared'
      onoe "Cannot specify both shared and universal (will not build)"
      exit 1
    end

    # Always include compiler-rt
    CompilerRt.new("compiler-rt").brew { compilerrt_dir.install Dir['*'] }
    # Clang is optional
    Clang.new("clang").brew { clang_dir.install Dir['*'] } if build.include? 'with-clang'

    if build.universal?
      ENV['UNIVERSAL'] = '1'
      ENV['UNIVERSAL_ARCH'] = 'i386 x86_64'
    end

    ENV['REQUIRES_RTTI'] = '1' if build.include? 'rtti'

    args = [
      "--prefix=#{prefix}",
      "--enable-optimized",
      # As of LLVM 3.1, attempting to build ocaml bindings with Homebrew's
      # OCaml 3.12.1 results in errors.
      "--disable-bindings",
    ]

    if build.include? 'all-targets'
      args << "--enable-targets=all"
    else
      args << "--enable-targets=host"
    end
    args << "--enable-shared" if build.include? 'shared'

    system "./configure", *args
    system "make install"

    # install llvm python bindings
    (share/'llvm/bindings').install buildpath/'bindings/python'

    # install clang tools and bindings
    cd clang_dir do
      system 'make install'
      (share/'clang/tools').install 'tools/scan-build', 'tools/scan-view'
      (share/'clang/bindings').install 'bindings/python'
    end if build.include? 'with-clang'
  end

  def test
    system "#{bin}/llvm-config", "--version"
  end

  def caveats; <<-EOS.undent
    Extra tools and bindings are installed in #{share}/llvm and #{share}/clang.

    If you already have LLVM installed, then "brew upgrade llvm" might not work.
    Instead, try:
        brew rm llvm && brew install llvm
    EOS
  end

  def clang_dir
    buildpath/'tools/clang'
  end

  def compilerrt_dir
    buildpath/'projects/compiler-rt'
  end
end

# The following patch changes the version string from '3.2svn'
# to '3.2'. The bug is discussed here, and currently unresolved:
#
# http://llvm.org/bugs/show_bug.cgi?id=14715
__END__
diff -ur llvm-3.2.src/autoconf/configure.ac llvm-3.2.src-patched/autoconf/configure.ac
--- llvm-3.2.src/autoconf/configure.ac	2012-11-21 10:13:35.000000000 -0600
+++ llvm-3.2.src-patched/autoconf/configure.ac	2013-01-13 22:53:45.000000000 -0600
@@ -31,7 +31,7 @@
 dnl===-----------------------------------------------------------------------===
 dnl Initialize autoconf and define the package name, version number and
 dnl address for reporting bugs.
-AC_INIT([LLVM],[3.2svn],[http://llvm.org/bugs/])
+AC_INIT([LLVM],[3.2],[http://llvm.org/bugs/])
 AC_DEFINE([LLVM_VERSION_MAJOR], [3], [Major version of the LLVM API])
 AC_DEFINE([LLVM_VERSION_MINOR], [2], [Minor version of the LLVM API])
 
diff -ur llvm-3.2.src/configure llvm-3.2.src-patched/configure
--- llvm-3.2.src/configure	2012-11-21 10:13:35.000000000 -0600
+++ llvm-3.2.src-patched/configure	2013-01-13 22:53:45.000000000 -0600
@@ -1,6 +1,6 @@
 #! /bin/sh
 # Guess values for system-dependent variables and create Makefiles.
-# Generated by GNU Autoconf 2.60 for LLVM 3.2svn.
+# Generated by GNU Autoconf 2.60 for LLVM 3.2.
 #
 # Report bugs to <http://llvm.org/bugs/>.
 #
@@ -561,8 +561,8 @@
 # Identity of this package.
 PACKAGE_NAME='LLVM'
 PACKAGE_TARNAME='llvm'
-PACKAGE_VERSION='3.2svn'
-PACKAGE_STRING='LLVM 3.2svn'
+PACKAGE_VERSION='3.2'
+PACKAGE_STRING='LLVM 3.2'
 PACKAGE_BUGREPORT='http://llvm.org/bugs/'
 
 ac_unique_file="lib/VMCore/Module.cpp"
@@ -1321,7 +1321,7 @@
   # Omit some internal or obsolete options to make the list less imposing.
   # This message is too long to be a string in the A/UX 3.1 sh.
   cat <<_ACEOF
-\`configure' configures LLVM 3.2svn to adapt to many kinds of systems.
+\`configure' configures LLVM 3.2 to adapt to many kinds of systems.
 
 Usage: $0 [OPTION]... [VAR=VALUE]...
 
@@ -1387,7 +1387,7 @@
 
 if test -n "$ac_init_help"; then
   case $ac_init_help in
-     short | recursive ) echo "Configuration of LLVM 3.2svn:";;
+     short | recursive ) echo "Configuration of LLVM 3.2:";;
    esac
   cat <<\_ACEOF
 
@@ -1540,7 +1540,7 @@
 test -n "$ac_init_help" && exit $ac_status
 if $ac_init_version; then
   cat <<\_ACEOF
-LLVM configure 3.2svn
+LLVM configure 3.2
 generated by GNU Autoconf 2.60
 
 Copyright (C) 1992, 1993, 1994, 1995, 1996, 1998, 1999, 2000, 2001,
@@ -1556,7 +1556,7 @@
 This file contains any messages produced by compilers while
 running configure, to aid debugging if configure makes a mistake.
 
-It was created by LLVM $as_me 3.2svn, which was
+It was created by LLVM $as_me 3.2, which was
 generated by GNU Autoconf 2.60.  Invocation command line was
 
   $ $0 $@
@@ -21574,7 +21574,7 @@
 # report actual input values of CONFIG_FILES etc. instead of their
 # values after options handling.
 ac_log="
-This file was extended by LLVM $as_me 3.2svn, which was
+This file was extended by LLVM $as_me 3.2, which was
 generated by GNU Autoconf 2.60.  Invocation command line was
 
   CONFIG_FILES    = $CONFIG_FILES
@@ -21627,7 +21627,7 @@
 _ACEOF
 cat >>$CONFIG_STATUS <<_ACEOF
 ac_cs_version="\\
-LLVM config.status 3.2svn
+LLVM config.status 3.2
 configured by $0, generated by GNU Autoconf 2.60,
   with options \\"`echo "$ac_configure_args" | sed 's/^ //; s/[\\""\`\$]/\\\\&/g'`\\"
 
diff -ur llvm-3.2.src/test/Transforms/LoopVectorize/2012-10-22-isconsec.ll llvm-3.2.src-patched/test/Transforms/LoopVectorize/2012-10-22-isconsec.ll
--- llvm-3.2.src/test/Transforms/LoopVectorize/2012-10-22-isconsec.ll	2012-10-26 13:52:01.000000000 -0500
+++ llvm-3.2.src-patched/test/Transforms/LoopVectorize/2012-10-22-isconsec.ll	2013-01-13 22:53:45.000000000 -0600
@@ -5,7 +5,7 @@
 target datalayout = "e-p:64:64:64-S128-i1:8:8-i8:8:8-i16:16:16-i32:32:32-i64:64:64-f16:16:16-f32:32:32-f64:64:64-f128:128:128-v64:64:64-v128:128:128-a0:0:64-s0:64:64-f80:128:128-n8:16:32:64"
 target triple = "x86_64-unknown-linux-gnu"
 
-module asm "\09.ident\09\22GCC: (GNU) 4.6.3 LLVM: 3.2svn\22"
+module asm "\09.ident\09\22GCC: (GNU) 4.6.3 LLVM: 3.2\22"
 
 @b = common global [32000 x float] zeroinitializer, align 16
 
