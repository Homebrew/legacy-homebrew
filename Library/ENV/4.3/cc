#!/System/Library/Frameworks/Ruby.framework/Versions/1.8/usr/bin/ruby -W0

#TODO make it work with homebrew/dupes/gcc
#TODO? If we find -mmacosx-version-min=10.8, change sdkroot? warn visibly if no such SDK?
#TODO fix pkg-config files, should point to /usr/local or /usr/local/opt
#TODO create mechanism to specify build effects like %w{-O0 -O4 vanilla-arg-parsing sdk=10.6} etc.

require "#{File.dirname __FILE__}/../libsuperenv"
require 'set'

def cccfg? flags
  flags.split('').all?{|c| ENV['HOMEBREW_CCCFG'].include? c } if ENV['HOMEBREW_CCCFG']
end
def nclt?
  $sdkroot != nil
end
def clt?
  not nclt?
end
def syspath
  # $sdkroot is nil if we are a CLT configuration
  %W{#$sdkroot/usr #$sdkroot/usr/local}
end
def syslibpath
  # We reject brew's lib directory and never add it, instead we add all
  # dependency opt/lib directories.
  syspath.map{|d| "#{d}/lib" }
end
def cpath
  cpath = ENV['CMAKE_PREFIX_PATH'].split(':').map{|d| "#{d}/include" }
  cpath += ENV['CMAKE_INCLUDE_PATH'].split(':')
  cpath.delete("#$sdkroot/usr/include")
  cpath.delete("#$brewfix/include")
  opt = cpath.select{|prefix| prefix =~ %r{^#$brewfix/opt} }
  sys = cpath - opt
  [sys, opt]
end
def libpath
  ENV['CMAKE_PREFIX_PATH'].split(':').map{|d| "#{d}/lib" } +
  ENV['CMAKE_LIBRARY_PATH'].split(':') - %W{#$brewfix/lib}
end

class Cmd
  def initialize path, args
    @arg0 = path.basename.freeze
    @args = args.freeze
  end
  def mode
    if @arg0 == 'cpp' or @arg0 == 'ld'
      @arg0.to_sym
    elsif @args.include? '-c'
      :cc
    elsif @args.include? '-E'
      :cpp
    else
      :ccld
    end
  end
  def tool
    @tool ||= case @arg0
    when 'ld' then 'ld'
    when 'cc', 'c99', 'c89'
      # Ideally we would run `cx9`, however these tools are POSIX compliant
      # and don't support many flags. We need -isystem for instance, but also
      # reliability is generally much higher if we just get clang/gcc to do
      # the work since Makefiles are dumb and include a lot of excess flags.
      ENV['HOMEBREW_CC']
    when 'c++'
      if ENV['HOMEBREW_CC'] =~ /gcc/
        'g++'
      else
        'clang++'
      end
    else
      @arg0
    end
  end
  def args
    args = fix_args(@args)
    args = refurbish_args(args) if cccfg? 'O' and tool != 'ld'
    make_fuss(args)
    args << "-F/System/Library/Frameworks" << "-F/Library/Frameworks" if clt?
    args << "-v" if ENV['VERBOSE'].to_s >= '2' and cccfg? 'O'
    case mode
    when :cpp
      %w{-E} + args + cppflags
    when :ld
      ldflags + args
    when :cc
      cflags + args + cppflags
    when :ccld
      cflags + args + cppflags + ldflags
    end.compact
  end
  def fix_args inargs
    set = Set.new((libpath + syslibpath + cpath.flatten).map{|path| path.cleanpath })
    outargs = []
    whittler = inargs.each
    loop do
      case arg = whittler.next
      when /^-(L|I|isystem)(.*)/
        # it is okay to add a space after the -I; so let's support it
        path = $2.chuzzle || whittler.next
        flag = $1
        case path.cleanpath
        when *set.to_a
          # NOOP
        when %r{^#$brewfix}
          ENV['CMAKE_PREFIX_PATH'].split(':').find do |cmake_prefix|
            path.cleanpath.start_with? cmake_prefix.cleanpath
          end
        when %r{^/opt}, %r{^/sw}, %r{/usr/X11}
          # NOOP: forbidden paths
        else
          true
        end && begin
          set.add(path.cleanpath)
          outargs << "-#{flag}#{path}"
        end
      else
        outargs << arg
      end
    end
    outargs
  end
  def refurbish_args inargs
    args = []
    whittler = inargs.each
    loop do
      case arg = whittler.next
      when '-arch', /^-Xarch_/
        whittler.next
      when /^-g\d?/, /^-gstabs\d+/, '-gstabs+', /^-ggdb\d?/, '-gdwarf-2',
           /^-march=.+/, /^-mtune=.+/, '-m64', '-m32',
           /^-O[0-9zs]?/, '-fast',
           '-pedantic', '-pedantic-errors'
      when '-fopenmp', '-lgomp'
        # clang doesn't support OpenMP
        args << arg if not tool =~ /^clang/
      when /^-W.*/
        args << arg if arg =~ /^-Wl,/
      when '-macosx_version_min', '-dylib_install_name'
        args << "-Wl,#{arg},#{whittler.next}"
      when '-dylib'
        args << "-Wl,#{arg}"
      else
        args << arg
      end
    end
    args
  end
  def cflags
    if cccfg? 'Ob'
      %w{-mtune=generic -Oz}
    elsif cccfg? 'O'
      args = %w{-pipe -w -Os}
      args << '-march=native' if tool =~ /clang/
      args += %w{-arch i386 -arch x86_64} if cccfg? 'u'
      args << "--std=#{@arg0}" if @arg0 =~ /c[89]9/
      args
    else
      []
    end
  end
  def ldflags
    libpath.to_flags('-L') + if clt?
      %w{-Z -L/usr/lib}
    elsif tool == 'ld'
      %W{-syslibroot #$sdkroot}
    else
      []
    end
  end
  def cppflags
    sys, opt = cpath
    # we want our keg-only includes to be found before system includes *and*
    # before any other includes the build-system adds
    sys.to_flags('-isystem') + opt.to_flags('-I') + if clt?
      %w{-isystem/usr/include/c++/4.2.1
         -isystem/usr/include/c++/4.2.1/backward
         -isystem/usr/include
         -nostdlibinc}
    else
      %W{--sysroot=#$sdkroot}
    end
  end
  def make_fuss args
    dels = @args - args
    adds = args - @args
    dups = dels & args
    puts "brew: Superenv removed: #{dels*' '}" unless dels.empty?
    puts "brew: Superenv deduped: #{dels}" unless dups.empty?
    puts "brew: Superenv added: #{adds*' '}" unless adds.empty?
  end
end

####################################################################### sanity
abort "The build-tool has reset ENV. --env=std required." unless ENV['HOMEBREW_BREW_FILE']

case ENV['HOMEBREW_CC'].chuzzle when 'cc', nil
  # those values are not allowed
  ENV['HOMEBREW_CC'] = 'clang'
end

######################################################################### main
cmd = Cmd.new($0, ARGV)
exec "xcrun", cmd.tool, *cmd.args
